<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProForm Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- GLOBAL RESET & THEME --- */
    :root {
        --bg-light: #f4f4f4;
        --bg-panel: #ffffff;
        --text-dark: #333;
        --accent: #f56565;
        
        --bg-dark: #09090b;
        --bg-dark-panel: #141416;
        --text-light: #fff;
        --accent-orange: #ff6b2b;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; }

    /* --- LAYOUT GRID --- */
    .app-layout {
        display: grid;
        grid-template-columns: 450px 1fr; /* Fixed width Info, Fluid Vision */
        grid-template-rows: 100%;
        height: 100vh;
        width: 100vw;
    }

    /* --- LEFT PANE: INFO (The "Original App") --- */
    .info-pane {
        background: var(--bg-light);
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        z-index: 10;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }

    .info-header {
        background: var(--bg-panel);
        padding: 20px;
        border-bottom: 2px solid var(--accent);
        position: sticky; top: 0; z-index: 20;
    }
    .info-header h1 { margin: 0; color: var(--accent); font-size: 1.6rem; }
    
    .menu-btn { 
        position: absolute; top: 20px; right: 20px; 
        background: none; border: none; font-size: 1.5rem; color: var(--accent); cursor: pointer; 
    }

    .reference-media {
        background: #fff;
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-align: center;
    }
    .reference-media img {
        max-width: 100%;
        height: auto;
        max-height: 250px;
        object-fit: contain;
        border-radius: 4px;
    }

    .info-content { padding: 20px; flex-grow: 1; }
    .content-section { margin-bottom: 25px; }
    .content-section h2 { font-size: 1.1rem; color: var(--accent); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
    .content-section p, .content-section li { line-height: 1.6; color: #444; font-size: 0.95rem; margin-bottom: 8px; }
    .exercise-sets { font-size: 1.2rem; font-weight: 700; color: var(--accent); margin-bottom: 15px; }

    .pagination {
        padding: 15px;
        background: var(--bg-panel);
        border-top: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
    }
    .btn-nav { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-nav:disabled { background: #ddd; cursor: not-allowed; }

    /* --- RIGHT COLUMN: VISION WRAPPER --- */
    .vision-wrapper {
        background: var(--bg-dark);
        display: grid;
        grid-template-rows: auto 1fr; /* Video takes natural height, Dashboard takes rest */
        height: 100%;
        overflow-y: auto;
    }

    /* --- TOP RIGHT: VIDEO PANE --- */
    .video-pane {
        width: 100%;
        background: #000;
        position: relative;
        /* Force full width, let height adapt */
        aspect-ratio: 16/9; 
        max-height: 60vh; 
        border-bottom: 1px solid #333;
    }
    
    video, canvas {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ensures full width no matter what */
        display: block;
    }
    video { transform: scaleX(-1); } /* Mirror */

    /* Overlay on Video */
    .cam-overlay {
        position: absolute; inset: 0;
        background: rgba(0,0,0,0.7);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        z-index: 5;
    }
    .btn-start-cam {
        background: var(--accent-orange); color: white;
        border: none; padding: 12px 30px; border-radius: 30px;
        font-size: 1rem; font-weight: 700; cursor: pointer;
        box-shadow: 0 0 15px rgba(255, 107, 43, 0.4);
        transition: transform 0.2s;
    }
    .btn-start-cam:hover { transform: scale(1.05); }

    /* --- BOTTOM RIGHT: CONFIG DASHBOARD --- */
    .dashboard-pane {
        padding: 20px;
        background: var(--bg-dark);
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .dash-header h2 { margin: 0; font-size: 1.1rem; color: #888; }
    .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #222; color: #666; }
    .status-badge.active { background: rgba(74, 222, 128, 0.2); color: #4ade80; }

    /* Cards */
    .d-card {
        background: var(--bg-dark-panel);
        border: 1px solid #27272a;
        border-radius: 10px;
        padding: 15px;
    }

    /* Hero Card (Reps) */
    .d-card.hero {
        background: linear-gradient(135deg, var(--accent-orange), #ff8f50);
        border: none; color: white;
        display: flex; align-items: center; justify-content: space-between;
    }
    .rep-count { font-size: 3rem; font-weight: 700; line-height: 1; }
    .rep-label { font-size: 0.9rem; opacity: 0.9; }

    /* Gauge */
    .gauge-container { height: 8px; background: #222; border-radius: 4px; position: relative; overflow: hidden; margin-top: 10px; }
    .gauge-fill { height: 100%; background: var(--accent-orange); width: 0%; transition: width 0.1s; }
    .gauge-mark { position: absolute; top:0; bottom:0; width: 2px; background: #555; }

    /* Controls */
    .ctrl-row { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
    input[type=number] {
        background: #222; border: 1px solid #333; color: white;
        padding: 8px; border-radius: 6px; width: 80px;
    }
    .btn-reset {
        flex: 1; background: #222; border: 1px solid #333; color: #ccc;
        padding: 8px; border-radius: 6px; cursor: pointer;
    }
    .btn-reset:hover { background: #333; color: white; }

    /* --- MENU MODAL --- */
    .side-menu {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .side-menu.open { opacity: 1; pointer-events: auto; }
    .menu-content {
        position: absolute; top: 0; left: 0; bottom: 0; width: 300px;
        background: white; padding: 20px; overflow-y: auto;
        transform: translateX(-100%); transition: transform 0.3s;
    }
    .side-menu.open .menu-content { transform: translateX(0); }
    .menu-list button {
        width: 100%; text-align: left; padding: 12px 10px;
        background: none; border: none; border-bottom: 1px solid #eee;
        cursor: pointer; color: #333; font-size: 1rem;
    }
    .menu-list button:hover { background: #f9f9f9; color: var(--accent); }

    /* --- RESPONSIVE --- */
    @media (max-width: 900px) {
        .app-layout {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr; /* Video -> Stats -> Info */
            height: auto; min-height: 100vh; overflow-y: auto;
        }
        
        /* 1. Video on top */
        .vision-wrapper { 
            grid-row: 1; 
            display: contents; /* Removes wrapper box so children flow in main grid */
        }
        .video-pane { grid-row: 1; height: auto; max-height: 50vh; }
        .dashboard-pane { grid-row: 2; border-bottom: 1px solid #ddd; }

        /* 2. Info on bottom */
        .info-pane { grid-row: 3; height: auto; overflow: visible; }
    }
</style>
</head>
<body>

<div class="app-layout">
    
    <div class="info-pane">
        <header class="info-header">
            <h1 id="page-title">Welcome</h1>
            <button id="menu-btn" class="menu-btn">&#9776;</button>
        </header>

        <div class="reference-media" id="media-container">
            <img id="ref-image" src="" alt="Exercise Reference">
            <div id="video-embed-container" style="display:none; aspect-ratio:16/9; background:#000;"></div>
        </div>

        <div class="info-content" id="content-wrapper">
            <p style="text-align:center; color:#666; margin-top:20px;">Loading Workout...</p>
        </div>

        <nav class="pagination hidden" id="pagination">
            <button id="prev-btn" class="btn-nav">Previous</button>
            <span id="page-counter" style="color:#666; font-size:0.9rem;"></span>
            <button id="next-btn" class="btn-nav">Next</button>
        </nav>
    </div>

    <div class="vision-wrapper">
        
        <div class="video-pane">
            <video id="ai-video" playsinline muted></video>
            <canvas id="ai-canvas"></canvas>
            
            <div id="cam-overlay" class="cam-overlay">
                <h2 id="overlay-msg" style="color:white; font-weight:300; margin-bottom:20px;">AI TRACKER READY</h2>
                <button id="btn-start-cam" class="btn-start-cam">START CAMERA</button>
                <p style="color:#aaa; font-size:0.8rem; margin-top:15px;" id="ai-support-msg">
                    Select an exercise with AI support to begin.
                </p>
            </div>
        </div>

        <div class="dashboard-pane">
            <div class="dash-header">
                <h2>Rep Analysis</h2>
                <div id="ai-status" class="status-badge">Standby</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="d-card hero">
                    <div>
                        <div class="rep-label">Reps</div>
                        <div id="hud-reps" class="rep-count">0</div>
                    </div>
                    <div style="font-size:2rem;">ðŸ’ª</div>
                </div>

                <div class="d-card">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                        <span>Quality</span>
                        <span id="hud-pct" style="color:white; font-weight:bold;">0%</span>
                    </div>
                    <div class="gauge-container">
                        <div id="gauge-bar" class="gauge-fill"></div>
                        <div class="gauge-mark" style="left:50%"></div>
                        <div class="gauge-mark" style="left:85%"></div>
                    </div>
                </div>
            </div>

            <div class="d-card">
                <label style="font-size:0.8rem; color:#888;">Settings</label>
                <div class="ctrl-row">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:0.8rem;">Target:</span>
                        <input id="target-reps" type="number" value="12">
                    </div>
                    <button id="btn-reset" class="btn-reset">Reset Counter</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="side-menu" class="side-menu">
    <div class="menu-content">
        <button id="close-menu" style="background:none; border:none; font-size:2rem; float:right; cursor:pointer;">&times;</button>
        <h2 style="color:var(--accent); margin-top:10px;">Workout Plan</h2>
        <div id="menu-list" class="menu-list"></div>
    </div>
</div>

<script type="module">
    import {FilesetResolver, PoseLandmarker, DrawingUtils} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10";

    // --- 1. DOM ELEMENTS ---
    // Info Pane
    const titleEl = document.getElementById('page-title');
    const refImage = document.getElementById('ref-image');
    const vidEmbed = document.getElementById('video-embed-container');
    const contentWrap = document.getElementById('content-wrapper');
    const pagination = document.getElementById('pagination');
    const btnPrev = document.getElementById('prev-btn');
    const btnNext = document.getElementById('next-btn');
    const counterEl = document.getElementById('page-counter');
    
    // Menu
    const menuBtn = document.getElementById('menu-btn');
    const sideMenu = document.getElementById('side-menu');
    const menuList = document.getElementById('menu-list');
    const closeMenu = document.getElementById('close-menu');

    // Vision Pane
    const aiVideo = document.getElementById('ai-video');
    const aiCanvas = document.getElementById('ai-canvas');
    const aiCtx = aiCanvas.getContext('2d');
    const camOverlay = document.getElementById('cam-overlay');
    const btnStartCam = document.getElementById('btn-start-cam');
    const overlayMsg = document.getElementById('overlay-msg');
    const aiSupportMsg = document.getElementById('ai-support-msg');
    
    // Dashboard
    const elReps = document.getElementById('hud-reps');
    const elPct = document.getElementById('hud-pct');
    const elGauge = document.getElementById('gauge-bar');
    const elStatus = document.getElementById('ai-status');
    const inpTarget = document.getElementById('target-reps');
    const btnReset = document.getElementById('btn-reset');

    // --- 2. APP STATE ---
    let allData = {};
    let currentDayExercises = [];
    let currentIndex = 0;
    let currentAiType = null;

    // --- 3. AI TRACKER LOGIC ---
    class Tracker {
        constructor() {
            this.active = false;
            this.landmarker = null;
            this.reps = 0;
            this.target = 12;
            this.smoothed = 0;
            this.passedBottom = false;
            // Config
            this.thHigh = 85; this.thLow = 50;
            this.minAngle = 50; this.maxAngle = 170;
        }

        async init() {
            if(this.landmarker) return;
            const fs = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm");
            this.landmarker = await PoseLandmarker.createFromOptions(fs, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task" },
                runningMode: "VIDEO", numPoses: 1
            });
            console.log("AI Model Loaded");
        }

        async startCamera() {
            await this.init();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}, audio: false});
                aiVideo.srcObject = stream;
                await aiVideo.play();
                
                // Resize canvas to match video
                aiCanvas.width = aiVideo.videoWidth;
                aiCanvas.height = aiVideo.videoHeight;
                
                this.active = true;
                elStatus.textContent = "Active";
                elStatus.classList.add("active");
                this.loop();
            } catch(e) {
                alert("Camera Access Denied: " + e);
            }
        }

        stop() {
            this.active = false;
            elStatus.textContent = "Standby";
            elStatus.classList.remove("active");
            if(aiVideo.srcObject) {
                aiVideo.srcObject.getTracks().forEach(t => t.stop());
                aiVideo.srcObject = null;
            }
        }

        reset() {
            this.reps = 0;
            this.passedBottom = false;
            this.updateUI();
        }

        updateUI() {
            elReps.textContent = this.reps;
            elPct.textContent = Math.round(this.smoothed) + "%";
            elGauge.style.width = this.smoothed + "%";
            
            if(this.smoothed >= this.thHigh) elGauge.style.backgroundColor = "#4ade80"; 
            else if(this.smoothed <= this.thLow) elGauge.style.backgroundColor = "#ff6b2b";
            else elGauge.style.backgroundColor = "#fff";
        }

        processLandmarks(lms) {
            // Logic for Bicep Curl (Right Arm: 12-14-16)
            // You can expand this based on 'currentAiType'
            const s = lms[12], e = lms[14], w = lms[16];

            // Angle Calculation
            const v1 = {x:s.x-e.x, y:s.y-e.y}, v2 = {x:w.x-e.x, y:w.y-e.y};
            const dot = v1.x*v2.x + v1.y*v2.y;
            const mag = Math.hypot(v1.x,v1.y) * Math.hypot(v2.x,v2.y);
            const ang = Math.acos(dot/mag) * 180 / Math.PI;

            // Normalize
            const pct = Math.max(0, Math.min(1, (ang - this.minAngle)/(this.maxAngle - this.minAngle))) * 100;
            this.smoothed = this.smoothed * 0.8 + pct * 0.2;

            // Rep Counting
            if(this.smoothed <= this.thLow) this.passedBottom = true;
            if(this.passedBottom && this.smoothed >= this.thHigh) {
                this.reps++;
                this.passedBottom = false;
            }

            // Draw
            aiCtx.clearRect(0,0, aiCanvas.width, aiCanvas.height);
            aiCtx.save();
            aiCtx.scale(-1, 1);
            aiCtx.translate(-aiCanvas.width, 0);
            
            const draw = new DrawingUtils(aiCtx);
            draw.drawConnectors(lms, PoseLandmarker.POSE_CONNECTIONS, {color: "rgba(255,255,255,0.1)", lineWidth: 1});
            
            // Highlight Working Arm
            aiCtx.lineWidth = 5;
            aiCtx.strokeStyle = "#ff6b2b";
            aiCtx.beginPath();
            aiCtx.moveTo(s.x*aiCanvas.width, s.y*aiCanvas.height);
            aiCtx.lineTo(e.x*aiCanvas.width, e.y*aiCanvas.height);
            aiCtx.lineTo(w.x*aiCanvas.width, w.y*aiCanvas.height);
            aiCtx.stroke();

            aiCtx.restore();
            this.updateUI();
        }

        async loop() {
            if(!this.active) return;
            if(this.landmarker) {
                const res = this.landmarker.detectForVideo(aiVideo, performance.now());
                if(res.landmarks.length > 0) {
                    this.processLandmarks(res.landmarks[0]);
                } else {
                    aiCtx.clearRect(0,0, aiCanvas.width, aiCanvas.height);
                }
            }
            window.requestAnimationFrame(() => this.loop());
        }
    }
    const tracker = new Tracker();

    // --- 4. DATA LOADING & UI LOGIC ---
    
    async function initApp() {
        try {
            const res = await fetch('data.json');
            if(!res.ok) throw new Error("Could not load data.json");
            allData = await res.json();
            
            populateMenu();

            // Load Cover Image initially
            titleEl.textContent = "Welcome";
            refImage.src = "images/Cover Image.png"; 
            refImage.style.display = "inline-block";
            contentWrap.innerHTML = `<p style="text-align:center; margin-top:30px; color:#555;">Select a workout from the menu to begin.</p>`;
            
            // Hide dashboard/cam initially
            disableVisionPane("Select a workout to start");

        } catch(e) {
            contentWrap.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
        }
    }

    function populateMenu() {
        menuList.innerHTML = '';
        allData.workoutPlan.forEach(day => {
            const btn = document.createElement('button');
            btn.textContent = day.dayTitle;
            btn.onclick = () => {
                loadDay(day);
                toggleMenu(false);
            };
            menuList.appendChild(btn);
        });
    }

    function loadDay(day) {
        tracker.stop(); // Stop camera if running
        disableVisionPane("Select an exercise");
        
        titleEl.textContent = day.dayTitle;
        currentDayExercises = day.exercises;
        pagination.classList.add('hidden');
        
        // Show Cover Image again for the Day overview
        refImage.src = "images/Cover Image.png";
        refImage.style.display = "inline-block";
        vidEmbed.style.display = "none";
        vidEmbed.innerHTML = "";

        // Build list
        contentWrap.innerHTML = '';
        const purpose = document.createElement('div');
        purpose.innerHTML = `<p style="background:#fff5f5; border-left:4px solid #f56565; padding:10px;">${day.purpose}</p>`;
        contentWrap.appendChild(purpose);

        const list = document.createElement('ul');
        list.style.listStyle = "none";
        list.style.padding = 0;

        day.exercises.forEach((ex, idx) => {
            const details = allData.exerciseLibrary[ex.id];
            const li = document.createElement('li');
            li.style.background = "#fff";
            li.style.border = "1px solid #eee";
            li.style.marginBottom = "8px";
            li.style.padding = "15px";
            li.style.cursor = "pointer";
            li.style.borderRadius = "8px";
            li.innerHTML = `<strong>${details ? details.title : ex.id}</strong> <span style="color:#777; font-size:0.9em; float:right;">${ex.setsAndReps}</span>`;
            
            li.onclick = () => {
                currentIndex = idx;
                loadExercise(ex.id, ex.setsAndReps);
            };
            list.appendChild(li);
        });
        contentWrap.appendChild(list);
    }

    function loadExercise(id, setsReps) {
        const ex = allData.exerciseLibrary[id];
        if(!ex) return;

        // 1. Update Info Pane (Original App Functionality)
        titleEl.textContent = ex.title;
        pagination.classList.remove('hidden');
        updatePagination();

        // Handle Media
        if(ex.youtubeId) {
            refImage.style.display = "none";
            vidEmbed.style.display = "block";
            vidEmbed.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${ex.youtubeId}?rel=0" frameborder="0" allowfullscreen></iframe>`;
        } else {
            vidEmbed.style.display = "none";
            vidEmbed.innerHTML = "";
            refImage.style.display = "inline-block";
            refImage.src = ex.imagePath || "images/Cover Image.png";
        }

        // Build Content
        contentWrap.innerHTML = `
            <div class="exercise-sets">${setsReps}</div>
            ${ex.overview ? `<div class="content-section"><h2>Overview</h2><p>${ex.overview}</p></div>` : ''}
            ${ex.howTo ? `<div class="content-section"><h2>How To</h2><ul>${ex.howTo.map(i=>`<li>${i}</li>`).join('')}</ul></div>` : ''}
            ${ex.trainersTip ? `<div class="content-section"><h2>Trainer's Tip</h2><p style="font-style:italic; color:#555;">${ex.trainersTip}</p></div>` : ''}
        `;

        // 2. Update Vision Pane
        if(ex.aiType) {
            currentAiType = ex.aiType;
            enableVisionPane(ex.title, setsReps);
        } else {
            disableVisionPane("No AI support for this exercise");
        }
    }

    function updatePagination() {
        counterEl.textContent = `${currentIndex + 1} / ${currentDayExercises.length}`;
        btnPrev.disabled = currentIndex === 0;
        btnNext.disabled = currentIndex === currentDayExercises.length - 1;
    }

    // --- VISION PANE CONTROLLERS ---

    function enableVisionPane(title, setsReps) {
        // Prepare overlay
        camOverlay.style.display = "flex";
        btnStartCam.style.display = "block";
        btnStartCam.textContent = "START CAMERA";
        overlayMsg.textContent = "AI TRACKER READY";
        aiSupportMsg.textContent = `Tracking enabled for ${title}`;
        
        // Parse reps for target
        const match = setsReps.match(/x(\d+)/);
        if(match) inpTarget.value = parseInt(match[1]);
        tracker.target = parseInt(inpTarget.value);
    }

    function disableVisionPane(msg) {
        tracker.stop();
        camOverlay.style.display = "flex";
        btnStartCam.style.display = "none";
        overlayMsg.textContent = "STANDBY";
        aiSupportMsg.textContent = msg;
        aiCtx.clearRect(0,0, aiCanvas.width, aiCanvas.height);
    }

    // --- EVENTS ---

    // Nav
    btnPrev.onclick = () => {
        if(currentIndex > 0) {
            currentIndex--;
            const ex = currentDayExercises[currentIndex];
            loadExercise(ex.id, ex.setsAndReps);
        }
    };
    btnNext.onclick = () => {
        if(currentIndex < currentDayExercises.length - 1) {
            currentIndex++;
            const ex = currentDayExercises[currentIndex];
            loadExercise(ex.id, ex.setsAndReps);
        }
    };

    // Menu
    function toggleMenu(open) {
        if(open) sideMenu.classList.add('open');
        else sideMenu.classList.remove('open');
    }
    menuBtn.onclick = () => toggleMenu(true);
    closeMenu.onclick = () => toggleMenu(false);
    sideMenu.onclick = (e) => { if(e.target === sideMenu) toggleMenu(false); };

    // Cam Controls
    btnStartCam.onclick = () => {
        camOverlay.style.display = "none";
        tracker.startCamera();
    };
    btnReset.onclick = () => tracker.reset();
    inpTarget.onchange = () => { tracker.target = parseInt(inpTarget.value); };

    // Init
    initApp();

</script>
</body>
</html>
